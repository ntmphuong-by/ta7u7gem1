<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Unit 7 Traffic: Full Translation & Audio</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Nunito:wght@400;700;900&display=swap');

        :root {
            --primary: #2980b9;
            --secondary: #27ae60;
            --accent: #f1c40f;
            --wrong: #c0392b;
            --bg: #ecf0f1;
            --text: #2c3e50;
        }

        body {
            font-family: 'Nunito', sans-serif;
            background-color: var(--bg);
            color: var(--text);
            margin: 0;
            padding: 0;
            display: flex;
            justify-content: center;
            height: 100vh;
            overflow: hidden;
        }

        .game-container {
            width: 100%;
            max-width: 900px;
            background: white;
            display: flex;
            flex-direction: column;
            box-shadow: 0 0 20px rgba(0,0,0,0.1);
            height: 100%;
            position: relative;
        }

        /* HEADER */
        header {
            background: var(--primary);
            color: white;
            padding: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            z-index: 10;
        }

        .stats {
            font-size: 1.1rem;
            font-weight: 700;
            background: rgba(255,255,255,0.2);
            padding: 5px 15px;
            border-radius: 20px;
        }

        /* PROGRESS BAR */
        .progress-container {
            height: 8px;
            background: #bdc3c7;
            width: 100%;
            position: relative;
        }
        .progress-fill {
            height: 100%;
            background: var(--secondary);
            width: 0%;
            transition: width 0.3s;
        }
        .timer-line {
            position: absolute;
            top: 0; left: 0;
            height: 8px;
            background: var(--accent);
            width: 0%;
            opacity: 0.8;
        }

        /* MAIN CONTENT */
        main {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }

        .section-badge {
            display: inline-block;
            background: #8e44ad;
            color: white;
            padding: 5px 15px;
            border-radius: 5px;
            font-weight: bold;
            font-size: 0.9rem;
            margin-bottom: 15px;
            text-transform: uppercase;
        }

        /* DIALOGUE & READING BOX */
        .reading-box {
            background: #fdfbf7;
            border-left: 5px solid var(--secondary);
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 10px;
            max-height: 300px;
            overflow-y: auto;
            font-size: 1rem;
            line-height: 1.6;
            box-shadow: inset 0 0 5px rgba(0,0,0,0.05);
        }
        
        .role { font-weight: bold; margin-right: 5px; }
        .Mark { color: #2980b9; }
        .Lan { color: #c0392b; }
        .Narrator { color: #555; font-style: italic; }
        
        .vn-trans {
            display: block;
            color: #7f8c8d;
            font-style: italic;
            font-size: 0.9rem;
            margin-bottom: 8px;
            padding-left: 10px;
            border-left: 2px solid #bdc3c7;
        }
        .hidden { display: none; }

        .btn-control {
            background: #34495e;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 20px;
            cursor: pointer;
            margin-right: 10px;
            font-size: 0.9rem;
            display: inline-flex;
            align-items: center;
            gap: 5px;
            transition: 0.2s;
        }
        .btn-control:hover { background: #2c3e50; }
        .btn-control.playing { background: var(--secondary); animation: pulse 1s infinite; }
        .btn-trans { background: #e67e22; }
        .btn-trans:hover { background: #d35400; }

        @keyframes pulse { 0% {opacity:1;} 50% {opacity:0.7;} 100% {opacity:1;} }

        /* VISUAL QUESTION */
        .visual-box {
            font-size: 4rem;
            text-align: center;
            margin: 10px 0;
            padding: 20px;
            background: #f9f9f9;
            border: 2px dashed #bdc3c7;
            border-radius: 10px;
            display: inline-block;
            width: fit-content;
            align-self: center;
        }

        /* QUESTION TEXT */
        .question-text {
            font-size: 1.3rem;
            font-weight: 800;
            margin-bottom: 20px;
            color: var(--text);
        }

        /* OPTIONS */
        .options-grid {
            display: grid;
            gap: 12px;
            grid-template-columns: 1fr;
        }
        @media (min-width: 600px) { .options-grid { grid-template-columns: 1fr 1fr; } }

        .opt-btn {
            background: white;
            border: 2px solid #bdc3c7;
            padding: 15px;
            border-radius: 10px;
            font-size: 1.1rem;
            text-align: left;
            cursor: pointer;
            transition: 0.2s;
            color: var(--text);
            position: relative;
        }
        .opt-btn:hover:not(.disabled) { border-color: var(--primary); background: #ebf5fb; transform: translateY(-2px); }
        
        .opt-btn.correct { 
            background: #d5f5e3; border-color: var(--secondary); color: #1e8449; font-weight: bold; 
        }
        .opt-btn.wrong { 
            background: #fadbd8; border-color: var(--wrong); color: #943126; opacity: 0.7; 
        }
        .opt-btn.disabled { pointer-events: none; }

        /* FEEDBACK */
        .feedback {
            margin-top: 20px;
            padding: 15px;
            background: #eafaf1;
            border-radius: 10px;
            border: 1px solid #a9dfbf;
            display: none;
            animation: slideUp 0.3s;
        }
        .feedback.show { display: block; }
        @keyframes slideUp { from{transform:translateY(10px);opacity:0} to{transform:translateY(0);opacity:1} }

        .fb-status { font-weight: 900; font-size: 1.2rem; color: var(--secondary); margin-bottom: 5px; }
        .fb-trans { font-style: italic; color: #555; display: block; margin-bottom: 8px; }
        .fb-exp { color: var(--primary); font-weight: 700; line-height: 1.4; }
        .auto-msg { text-align: right; font-size: 0.8rem; color: #95a5a6; margin-top: 10px; font-style: italic; }

        /* START & END SCREENS */
        .screen-overlay {
            position: absolute; top:0; left:0; width:100%; height:100%;
            background: white;
            z-index: 20;
            display: flex; flex-direction: column;
            justify-content: center; align-items: center;
            text-align: center;
            padding: 20px;
        }
        .start-btn {
            font-size: 1.5rem; padding: 15px 50px;
            background: var(--primary); color: white; border: none;
            border-radius: 50px; cursor: pointer; margin-top: 30px;
            box-shadow: 0 5px 15px rgba(41,128,185,0.4);
            transition: transform 0.2s;
        }
        .start-btn:hover { transform: scale(1.05); }

    </style>
</head>
<body>

<div class="game-container">
    <header>
        <div style="font-size: 1.2rem; font-weight: 900;">üö¶ Traffic Unit 7 (V13)</div>
        <div class="stats">ƒêi·ªÉm: <span id="score">0</span>/<span id="total">0</span></div>
    </header>
    
    <div class="progress-container">
        <div class="progress-fill" id="progress"></div>
        <div class="timer-line" id="timer"></div>
    </div>

    <main id="game-area">
        </main>

    <div id="start-screen" class="screen-overlay">
        <h1 style="color:var(--primary); font-size:3rem; margin-bottom:10px;">TRAFFIC MASTER</h1>
        <p style="font-size:1.2rem; color:#555;">Full 68 c√¢u h·ªèi SGK - C√≥ d·ªãch ƒëo·∫°n ƒë·ªçc</p>
        <ul style="text-align:left; background:#f1f2f6; padding:20px; border-radius:10px; list-style:none;">
            <li>‚úÖ <b>Vocabulary:</b> Ph∆∞∆°ng ti·ªán, Bi·ªÉn b√°o</li>
            <li>‚úÖ <b>Grammar:</b> It (kho·∫£ng c√°ch), Should/Shouldn't</li>
            <li>‚úÖ <b>Skills:</b> ƒê·ªçc hi·ªÉu lu·∫≠t giao th√¥ng (C√≥ d·ªãch)</li>
            <li>‚úÖ <b>Audio:</b> Nghe h·ªôi tho·∫°i b·∫£n x·ª©</li>
        </ul>
        <button class="start-btn" onclick="startGame()">B·∫ÆT ƒê·∫¶U NGAY</button>
    </div>

    <div id="end-screen" class="screen-overlay" style="display:none;">
        <h1 style="color:var(--secondary); font-size:3rem;">HO√ÄN TH√ÄNH!</h1>
        <h2 style="font-size:2rem; margin:20px;">ƒêi·ªÉm s·ªë: <span id="final-score">0</span></h2>
        <button class="start-btn" onclick="location.reload()">L√†m l·∫°i b√†i</button>
    </div>
</div>

<script>
/* =================================================================
   1. D·ªÆ LI·ªÜU SGK (FULL TEXT & QUESTIONS)
   ================================================================= */

// H·ªòI THO·∫†I LAN & MARK (Getting Started) - C√≥ d·ªãch
const txtGS = [
    {r:"Lan", t:"Hi, Mark. How are you?", v:"Ch√†o Mark. B·∫°n kh·ªèe kh√¥ng?"},
    {r:"Mark", t:"Good, thanks. And you? What did you do last Sunday?", v:"Kh·ªèe, c·∫£m ∆°n. C√≤n b·∫°n? Ch·ªß nh·∫≠t r·ªìi b·∫°n l√†m g√¨?"},
    {r:"Lan", t:"I'm fine. Last Sunday afternoon, I cycled round the lake near my home.", v:"M√¨nh ·ªïn. Chi·ªÅu ch·ªß nh·∫≠t tr∆∞·ªõc, m√¨nh ƒë·∫°p xe quanh h·ªì g·∫ßn nh√†."},
    {r:"Mark", t:"That sounds really healthy. By the way, do you often cycle to school too?", v:"Nghe l√†nh m·∫°nh th·∫≠t ƒë·∫•y. Nh√¢n ti·ªán, b·∫°n c√≥ th∆∞·ªùng ƒë·∫°p xe ƒëi h·ªçc kh√¥ng?"},
    {r:"Lan", t:"Yes, but sometimes my mum takes me on her motorbike.", v:"C√≥, nh∆∞ng th·ªânh tho·∫£ng m·∫π ch·ªü m√¨nh b·∫±ng xe m√°y."},
    {r:"Mark", t:"How far is it from your home to school?", v:"T·ª´ nh√† b·∫°n ƒë·∫øn tr∆∞·ªùng bao xa?"},
    {r:"Lan", t:"It's about two kilometres.", v:"Kho·∫£ng 2 c√¢y s·ªë."},
    {r:"Mark", t:"How long does it take you to cycle there?", v:"B·∫°n ƒë·∫°p xe ƒë·∫øn ƒë√≥ m·∫•t bao l√¢u?"},
    {r:"Lan", t:"About 10 minutes. Sometimes, when there are traffic jams, it takes longer.", v:"Kho·∫£ng 10 ph√∫t. Th·ªânh tho·∫£ng khi k·∫πt xe th√¨ l√¢u h∆°n."},
    {r:"Mark", t:"You should be careful, especially when you cross the road.", v:"B·∫°n n√™n c·∫©n th·∫≠n, nh·∫•t l√† khi qua ƒë∆∞·ªùng."},
    {r:"Lan", t:"Right. The roads get really crowded.", v:"ƒê√∫ng r·ªìi. ƒê∆∞·ªùng x√° ƒë√¥ng ƒë√∫c l·∫Øm."},
    {r:"Mark", t:"Hey, how about going cycling round the lake this Sunday?", v:"N√†y, hay l√† ch·ªß nh·∫≠t n√†y ƒëi ƒë·∫°p xe quanh h·ªì ƒëi?"},
    {r:"Lan", t:"Great! Can you come to my house at 3 p.m.?", v:"Tuy·ªát! B·∫°n ƒë·∫øn nh√† m√¨nh l√∫c 3 gi·ªù chi·ªÅu ƒë∆∞·ª£c kh√¥ng?"},
    {r:"Mark", t:"OK, Lan. See you then.", v:"Ok Lan. G·∫∑p l·∫°i sau nh√©."}
];

// B√ÄI ƒê·ªåC TRAFFIC RULES (Skills 1) - C√≥ d·ªãch
const txtRules = [
    {r:"Narrator", t:"These are some rules about road safety. It is important to obey these rules when you are a road user.", v:"ƒê√¢y l√† m·ªôt s·ªë quy t·∫Øc v·ªÅ an to√†n giao th√¥ng. R·∫•t quan tr·ªçng ph·∫£i tu√¢n th·ªß khi b·∫°n tham gia giao th√¥ng."},
    {r:"Narrator", t:"Pedestrians:", v:"Ng∆∞·ªùi ƒëi b·ªô:"},
    {r:"Narrator", t:"1. Always look carefully when you cross the street.", v:"1. Lu√¥n quan s√°t c·∫©n th·∫≠n khi sang ƒë∆∞·ªùng."},
    {r:"Narrator", t:"2. Use the pavement or footpath.", v:"2. S·ª≠ d·ª•ng v·ªâa h√® ho·∫∑c ƒë∆∞·ªùng ƒëi b·ªô."},
    {r:"Narrator", t:"3. Walk across the street at the zebra crossing.", v:"3. Sang ƒë∆∞·ªùng t·∫°i v·∫°ch k·∫ª ƒë∆∞·ªùng d√†nh cho ng∆∞·ªùi ƒëi b·ªô."},
    {r:"Narrator", t:"4. Don't cross the road on a red light.", v:"4. Kh√¥ng sang ƒë∆∞·ªùng khi ƒë√®n ƒë·ªè."},
    {r:"Narrator", t:"Cyclists:", v:"Ng∆∞·ªùi ƒëi xe ƒë·∫°p:"},
    {r:"Narrator", t:"1. Always keep both hands on the handlebars.", v:"1. Lu√¥n gi·ªØ hai tay tr√™n ghi ƒë√¥ng."},
    {r:"Narrator", t:"2. Wear helmets, and always use the cycle lane.", v:"2. ƒê·ªôi m≈© b·∫£o hi·ªÉm v√† lu√¥n ƒëi trong l√†n xe ƒë·∫°p."},
    {r:"Narrator", t:"3. Give a signal before you turn.", v:"3. Ra t√≠n hi·ªáu tr∆∞·ªõc khi r·∫Ω."},
    {r:"Narrator", t:"4. Don't carry more than one passenger.", v:"4. Kh√¥ng ch·ªü qu√° m·ªôt ng∆∞·ªùi."},
    {r:"Narrator", t:"Passengers:", v:"H√†nh kh√°ch:"},
    {r:"Narrator", t:"1. Fasten your seatbelt when you are in a car.", v:"1. Th·∫Øt d√¢y an to√†n khi ng·ªìi trong √¥ t√¥."},
    {r:"Narrator", t:"2. Wait for buses to fully stop before getting on or off.", v:"2. Ch·ªù xe bu√Ωt d·ª´ng h·∫≥n tr∆∞·ªõc khi l√™n ho·∫∑c xu·ªëng."},
    {r:"Narrator", t:"3. Don't talk to the driver when he or she is driving.", v:"3. Kh√¥ng n√≥i chuy·ªán v·ªõi t√†i x·∫ø khi h·ªç ƒëang l√°i xe."},
    {r:"Narrator", t:"4. Don't stick any body parts out of the window of a moving vehicle.", v:"4. Kh√¥ng th√≤ b·∫•t k·ª≥ b·ªô ph·∫≠n n√†o c·ªßa c∆° th·ªÉ ra ngo√†i c·ª≠a s·ªï."}
];

// DANH S√ÅCH C√ÇU H·ªéI (68 C√¢u)
// C·∫•u tr√∫c: {sec: 'Ph·∫ßn', type: 'text/vis/dialogue', content: [], q: 'C√¢u h·ªèi', ans: 'ƒê√°p √°n ƒë√∫ng', wrongs: ['Sai 1', 'Sai 2', 'Sai 3'], trans: 'D·ªãch', exp: 'Gi·∫£i th√≠ch'}
const db = [
    // --- GETTING STARTED ---
    {
        sec: "Getting Started", type: "dialogue", content: txtGS,
        q: "1. How does Lan often go to school?",
        ans: "By bicycle", wrongs: ["By motorbike", "On foot"],
        trans: "Lan th∆∞·ªùng ƒëi h·ªçc b·∫±ng g√¨? -> Xe ƒë·∫°p.", exp: "Lan tr·∫£ l·ªùi 'Yes' khi Mark h·ªèi v·ªÅ vi·ªác ƒë·∫°p xe th∆∞·ªùng xuy√™n."
    },
    {
        sec: "Getting Started", type: "text",
        q: "2. It normally takes Lan ______ to get to school.",
        ans: "about 10 minutes", wrongs: ["2 minutes", "20 minutes"],
        trans: "Lan m·∫•t kho·∫£ng 10 ph√∫t.", exp: "Lan n√≥i: 'About 10 minutes'."
    },
    {
        sec: "Getting Started", type: "text",
        q: "3. Lan and Mark agree to go cycling ______.",
        ans: "at the weekend", wrongs: ["tomorrow", "every day"],
        trans: "H·ªç ƒëi xe ƒë·∫°p v√†o cu·ªëi tu·∫ßn.", exp: "Mark r·ªß: 'this Sunday'."
    },
    // Ex 3: Fill words
    { sec: "Getting Started (Ex 3)", type: "text", q: "4. Last Sunday afternoon, Lan ______ round the lake.", ans: "cycled", wrongs: ["walked", "ran"], trans: "Lan ƒë√£ ƒê·∫†P XE quanh h·ªì.", exp: "Trong b√†i: 'I cycled round the lake'." },
    { sec: "Getting Started (Ex 3)", type: "text", q: "5. Mark says: 'You ______ be careful'.", ans: "should", wrongs: ["can", "will"], trans: "B·∫°n N√äN c·∫©n th·∫≠n.", exp: "Mark khuy√™n Lan." },
    { sec: "Getting Started (Ex 3)", type: "text", q: "6. Traffic ______ are a problem in big cities.", ans: "jams", wrongs: ["lights", "rules"], trans: "T·∫ÆC ƒë∆∞·ªùng.", exp: "Traffic jams." },
    { sec: "Getting Started (Ex 3)", type: "text", q: "7. This road is very ______ during rush hours.", ans: "crowded", wrongs: ["quiet", "safe"], trans: "ƒê∆∞·ªùng r·∫•t ƒê√îNG ƒê√öC.", exp: "Crowded." },
    
    // Ex 4: Transport (Pictures -> Emoji)
    { sec: "Getting Started (Ex 4)", type: "vis", vis: "üö≤", q: "What is this?", ans: "bicycle", wrongs: ["motorbike", "bus", "car"], trans: "Xe ƒë·∫°p.", exp: "" },
    { sec: "Getting Started (Ex 4)", type: "vis", vis: "üöó", q: "What is this?", ans: "car", wrongs: ["bus", "train", "plane"], trans: "Xe √¥ t√¥.", exp: "" },
    { sec: "Getting Started (Ex 4)", type: "vis", vis: "üöå", q: "What is this?", ans: "bus", wrongs: ["train", "ship", "boat"], trans: "Xe bu√Ωt.", exp: "" },
    { sec: "Getting Started (Ex 4)", type: "vis", vis: "üèçÔ∏è", q: "What is this?", ans: "motorbike", wrongs: ["bicycle", "plane", "car"], trans: "Xe m√°y.", exp: "" },
    { sec: "Getting Started (Ex 4)", type: "vis", vis: "‚úàÔ∏è", q: "What is this?", ans: "plane", wrongs: ["ship", "train", "bus"], trans: "M√°y bay.", exp: "" },
    { sec: "Getting Started (Ex 4)", type: "vis", vis: "üöÜ", q: "What is this?", ans: "train", wrongs: ["bus", "car", "bicycle"], trans: "T√†u h·ªèa.", exp: "" },
    { sec: "Getting Started (Ex 4)", type: "vis", vis: "üö§", q: "What is this?", ans: "boat", wrongs: ["ship", "car", "plane"], trans: "Thuy·ªÅn nh·ªè.", exp: "" },
    { sec: "Getting Started (Ex 4)", type: "vis", vis: "üö¢", q: "What is this?", ans: "ship", wrongs: ["boat", "train", "bus"], trans: "T√†u th·ªßy l·ªõn.", exp: "" },

    // --- A CLOSER LOOK 1 ---
    // Ex 1: Match
    { sec: "A Closer Look 1 (Ex 1)", type: "text", q: "Choose the correct phrase: ______ a bike", ans: "ride", wrongs: ["drive", "sail", "fly"], trans: "L√°i xe ƒë·∫°p (Ride).", exp: "Ride a bike/horse." },
    { sec: "A Closer Look 1 (Ex 1)", type: "text", q: "Choose the correct phrase: ______ a car", ans: "drive", wrongs: ["ride", "sail", "go"], trans: "L√°i √¥ t√¥ (Drive).", exp: "Drive a car/bus." },
    { sec: "A Closer Look 1 (Ex 1)", type: "text", q: "Choose the correct phrase: ______ a boat", ans: "sail", wrongs: ["drive", "ride", "fly"], trans: "L√°i thuy·ªÅn (Sail).", exp: "Sail a boat." },
    { sec: "A Closer Look 1 (Ex 1)", type: "text", q: "Choose the correct phrase: ______ on foot", ans: "go", wrongs: ["drive", "ride", "travel"], trans: "ƒêi b·ªô (Go on foot).", exp: "" },
    { sec: "A Closer Look 1 (Ex 1)", type: "text", q: "Choose the correct phrase: ______ by air", ans: "travel", wrongs: ["drive", "ride", "sail"], trans: "ƒêi l·∫°i b·∫±ng m√°y bay.", exp: "Travel by air." },

    // Ex 2: Signs (Visuals)
    { sec: "A Closer Look 1 (Ex 2)", type: "vis", vis: "üö¶", q: "What does this sign mean?", ans: "Traffic lights", wrongs: ["No parking", "Stop", "Hospital ahead"], trans: "ƒê√®n giao th√¥ng.", exp: "" },
    { sec: "A Closer Look 1 (Ex 2)", type: "vis", vis: "üè•", q: "What does this sign mean?", ans: "Hospital ahead", wrongs: ["School ahead", "Hotel ahead", "No cycling"], trans: "B·ªánh vi·ªán ph√≠a tr∆∞·ªõc.", exp: "" },
    { sec: "A Closer Look 1 (Ex 2)", type: "vis", vis: "‚≠ï‚Ü±", q: "What does this sign mean?", ans: "No right turn", wrongs: ["Right turn only", "Cycle lane", "No left turn"], trans: "C·∫•m r·∫Ω ph·∫£i.", exp: "V√≤ng tr√≤n ƒë·ªè g·∫°ch ch√©o l√† C·∫•m." },
    { sec: "A Closer Look 1 (Ex 2)", type: "vis", vis: "üü¶üö≤", q: "What does this sign mean?", ans: "Cycle lane", wrongs: ["No cycling", "Parking", "Traffic lights"], trans: "L√†n ƒë∆∞·ªùng xe ƒë·∫°p.", exp: "Bi·ªÉn xanh vu√¥ng l√† ch·ªâ d·∫´n." },
    { sec: "A Closer Look 1 (Ex 2)", type: "vis", vis: "‚ö†Ô∏èüèÉ", q: "What does this sign mean?", ans: "School ahead", wrongs: ["Hospital ahead", "No running", "Traffic lights"], trans: "Tr∆∞·ªùng h·ªçc ph√≠a tr∆∞·ªõc.", exp: "Bi·ªÉn tam gi√°c v√†ng l√† c·∫£nh b√°o." },
    { sec: "A Closer Look 1 (Ex 2)", type: "vis", vis: "‚≠ïüö≤", q: "What does this sign mean?", ans: "No cycling", wrongs: ["Cycle lane", "Ride a bike", "School ahead"], trans: "C·∫•m xe ƒë·∫°p.", exp: "V√≤ng tr√≤n ƒë·ªè g·∫°ch ch√©o." },

    // Ex 5: Pronunciation
    { sec: "Pronunciation", type: "text", q: "Which word has sound **/a…™/**?", ans: "cycle", wrongs: ["sail", "train", "plane"], trans: "Ch·ªçn t·ª´ c√≥ √¢m /ai/.", exp: "Cycle /sa…™kl/." },
    { sec: "Pronunciation", type: "text", q: "Which word has sound **/a…™/**?", ans: "fly", wrongs: ["pay", "stay", "wait"], trans: "Ch·ªçn t·ª´ c√≥ √¢m /ai/.", exp: "Fly /fla…™/." },
    { sec: "Pronunciation", type: "text", q: "Which word has sound **/e…™/**?", ans: "station", wrongs: ["fine", "sign", "cycle"], trans: "Ch·ªçn t·ª´ c√≥ √¢m /ei/.", exp: "Station /ste…™ Én/." },
    { sec: "Pronunciation", type: "text", q: "Which word has sound **/e…™/**?", ans: "train", wrongs: ["time", "light", "my"], trans: "Ch·ªçn t·ª´ c√≥ √¢m /ei/.", exp: "Train /tre…™n/." },

    // --- A CLOSER LOOK 2 ---
    // Ex 1: Distance
    { sec: "A Closer Look 2 (Grammar)", type: "text", q: "Make sentence: 700m / my flat / Youth Club", ans: "It is about 700m from my flat to the Youth Club.", wrongs: ["My flat is 700m to the Youth Club.", "It is 700m my flat to Youth Club."], trans: "Kho·∫£ng 700m t·ª´ nh√† t√¥i ƒë·∫øn CLB.", exp: "C·∫•u tr√∫c: It is + distance + from A + to B." },
    { sec: "A Closer Look 2 (Grammar)", type: "text", q: "Make sentence: 5 km / my village / nearest town", ans: "It is about 5 km from my village to the nearest town.", wrongs: ["It is 5 km from my village the nearest town.", "My village is 5 km to the nearest town."], trans: "Kho·∫£ng 5km t·ª´ l√†ng ƒë·∫øn th·ªã tr·∫•n.", exp: "" },
    { sec: "A Closer Look 2 (Grammar)", type: "text", q: "Make sentence: 120 km / HCMC / Vung Tau", ans: "It is about 120 km from HCMC to Vung Tau.", wrongs: ["From HCMC to Vung Tau is 120 km.", "It is 120 km HCMC to Vung Tau."], trans: "Kho·∫£ng 120km t·ª´ TP.HCM ƒëi V≈©ng T√†u.", exp: "" },
    { sec: "A Closer Look 2 (Grammar)", type: "text", q: "Make sentence: 384,400 km / Earth / Moon", ans: "It is about 384,400 km from the Earth to the Moon.", wrongs: ["The Earth is 384,400 km to the Moon.", "It is 384,400 km the Earth to the Moon."], trans: "Kho·∫£ng c√°ch t·ª´ Tr√°i ƒê·∫•t ƒë·∫øn M·∫∑t TrƒÉng.", exp: "" },
    { sec: "A Closer Look 2 (Grammar)", type: "text", q: "Make sentence: not very far / Ha Noi / Noi Bai Airport", ans: "It is not very far from Ha Noi to Noi Bai Airport.", wrongs: ["It not very far from Ha Noi to Noi Bai Airport.", "Ha Noi is not very far to Noi Bai Airport."], trans: "Kh√¥ng xa l·∫Øm t·ª´ HN ƒë·∫øn s√¢n bay NB.", exp: "" },

    // Ex 3: Should/Shouldn't (Choice)
    { sec: "Grammar: Should", type: "text", q: "You ______ read that book. It's interesting.", ans: "should", wrongs: ["shouldn't", "mustn't"], trans: "B·∫°n N√äN ƒë·ªçc s√°ch ƒë√≥.", exp: "L·ªùi khuy√™n t√≠ch c·ª±c." },
    { sec: "Grammar: Should", type: "text", q: "You ______ be more careful. You nearly fell!", ans: "should", wrongs: ["shouldn't", "won't"], trans: "B·∫°n N√äN c·∫©n th·∫≠n.", exp: "" },
    { sec: "Grammar: Should", type: "text", q: "We ______ go swimming right after eating.", ans: "shouldn't", wrongs: ["should", "can"], trans: "KH√îNG N√äN b∆°i ngay sau khi ƒÉn.", exp: "H·∫°i s·ª©c kh·ªèe." },
    { sec: "Grammar: Should", type: "text", q: "He ______ eat less. He's becoming overweight.", ans: "should", wrongs: ["shouldn't", "mustn't"], trans: "Anh ·∫•y N√äN ƒÉn √≠t l·∫°i.", exp: "" },
    { sec: "Grammar: Should", type: "text", q: "He ______ drive so fast. There are many cars.", ans: "shouldn't", wrongs: ["should", "can"], trans: "Anh ·∫•y KH√îNG N√äN l√°i nhanh.", exp: "" },

    // Ex 4: Fill in blanks
    { sec: "Grammar: Should", type: "text", q: "We ______ ride our motorbikes very fast in the rain.", ans: "shouldn't", wrongs: ["should"], trans: "KH√îNG N√äN l√°i nhanh khi m∆∞a.", exp: "Nguy hi·ªÉm." },
    { sec: "Grammar: Should", type: "text", q: "You ______ study instead of watching YouTube.", ans: "should", wrongs: ["shouldn't"], trans: "N√äN h·ªçc b√†i.", exp: "Vi·ªác t·ªët." },
    { sec: "Grammar: Should", type: "text", q: "My little sister ______ play outside late at night.", ans: "shouldn't", wrongs: ["should"], trans: "KH√îNG N√äN ch∆°i khuya.", exp: "Nguy hi·ªÉm." },
    { sec: "Grammar: Should", type: "text", q: "You ______ help your mum wash the dishes.", ans: "should", wrongs: ["shouldn't"], trans: "N√äN gi√∫p m·∫π.", exp: "Vi·ªác t·ªët." },
    { sec: "Grammar: Should", type: "text", q: "You look tired. You ______ get some sleep.", ans: "should", wrongs: ["shouldn't"], trans: "N√äN ƒëi ng·ªß.", exp: "S·ª©c kh·ªèe." },
    { sec: "Grammar: Should", type: "text", q: "The children ______ eat so much ice cream.", ans: "shouldn't", wrongs: ["should"], trans: "KH√îNG N√äN ƒÉn nhi·ªÅu kem.", exp: "H·∫°i h·ªçng/rƒÉng." },

    // Ex 5: Picture Cues (Visuals)
    { sec: "Grammar: Situations", type: "vis", vis: "üö∞", q: "He is wasting water. He ______ do that.", ans: "shouldn't", wrongs: ["should"], trans: "Anh ·∫•y KH√îNG N√äN l√£ng ph√≠ n∆∞·ªõc.", exp: "" },
    { sec: "Grammar: Situations", type: "vis", vis: "‚õëÔ∏è", q: "They are riding bikes. They ______ wear helmets.", ans: "should", wrongs: ["shouldn't"], trans: "N√äN ƒë·ªôi m≈© b·∫£o hi·ªÉm.", exp: "Lu·∫≠t an to√†n." },
    { sec: "Grammar: Situations", type: "vis", vis: "üìöüö≤", q: "She dropped her books. She ______ be more careful.", ans: "should", wrongs: ["shouldn't"], trans: "N√äN c·∫©n th·∫≠n h∆°n.", exp: "" },
    { sec: "Grammar: Situations", type: "vis", vis: "‚öΩüõ£Ô∏è", q: "They ______ play football on the pavement.", ans: "shouldn't", wrongs: ["should"], trans: "KH√îNG N√äN ƒë√° b√≥ng tr√™n v·ªâa h√®.", exp: "Nguy hi·ªÉm." },
    { sec: "Grammar: Situations", type: "vis", vis: "üö≤üëê", q: "They ______ ride their bikes dangerously.", ans: "shouldn't", wrongs: ["should"], trans: "KH√îNG N√äN l√°i xe nguy hi·ªÉm.", exp: "" },

    // --- SKILLS 1 (Reading) ---
    {
        sec: "Skills 1: Reading Rules", type: "dialogue", content: txtRules,
        q: "1. Where should pedestrians cross the street?",
        ans: "At the zebra crossing", wrongs: ["Anywhere", "Near the bus stop", "In the middle of road"],
        trans: "Ng∆∞·ªùi ƒëi b·ªô n√™n sang ƒë∆∞·ªùng ·ªü v·∫°ch k·∫ª.", exp: "Rule 3 (Pedestrians)."
    },
    {
        sec: "Skills 1: Reading", type: "text",
        q: "2. Which lane should cyclists use?",
        ans: "Cycle lane", wrongs: ["Car lane", "Pavement", "Footpath"],
        trans: "Ng∆∞·ªùi ƒëi xe ƒë·∫°p d√πng l√†n xe ƒë·∫°p.", exp: "Rule 2 (Cyclists)."
    },
    {
        sec: "Skills 1: Reading", type: "text",
        q: "3. What should cyclists do before turning?",
        ans: "Give a signal", wrongs: ["Stop", "Shout", "Ride faster"],
        trans: "Ra t√≠n hi·ªáu tr∆∞·ªõc khi r·∫Ω.", exp: "Rule 3 (Cyclists)."
    },
    {
        sec: "Skills 1: Reading", type: "text",
        q: "4. What must you do when getting on/off a bus?",
        ans: "Wait for it to stop fully", wrongs: ["Jump quickly", "Push others", "Run"],
        trans: "Ch·ªù xe d·ª´ng h·∫≥n.", exp: "Rule 2 (Passengers)."
    },
    {
        sec: "Skills 1: Reading", type: "text",
        q: "5. What must you NOT do in a moving vehicle?",
        ans: "Stick body parts out of window", wrongs: ["Wear a seatbelt", "Sit still", "Talk softly"],
        trans: "Kh√¥ng th√≤ ƒë·∫ßu/tay ra ngo√†i c·ª≠a s·ªï.", exp: "Rule 4 (Passengers)."
    },

    // --- LOOKING BACK ---
    // Ex 2: Fill gaps
    { sec: "Looking Back", type: "text", q: "1. A road ______ is anyone who uses a road.", ans: "user", wrongs: ["worker", "safety", "maker"], trans: "Ng∆∞·ªùi tham gia giao th√¥ng.", exp: "Road user." },
    { sec: "Looking Back", type: "text", q: "2. Does your dad ______ his motorbike carefully?", ans: "ride", wrongs: ["drive", "sail", "fly"], trans: "L√°i xe m√°y.", exp: "Motorbike d√πng 'ride'." },
    { sec: "Looking Back", type: "text", q: "3. A ______ is a person travelling in a vehicle but not driving.", ans: "passenger", wrongs: ["pilot", "driver", "cyclist"], trans: "H√†nh kh√°ch.", exp: "Passenger." },
    { sec: "Looking Back", type: "text", q: "4. He is learning to ______ planes.", ans: "fly", wrongs: ["ride", "drive", "sail"], trans: "L√°i m√°y bay.", exp: "Plane d√πng 'fly'." },
    { sec: "Looking Back", type: "text", q: "5. Be careful when the traffic ______ turns yellow.", ans: "light", wrongs: ["sign", "rule", "jam"], trans: "ƒê√®n giao th√¥ng.", exp: "Traffic light." },
    
    // Ex 3: Distance
    { sec: "Looking Back", type: "text", q: "Make sentence: not very far / school / museum", ans: "It is not very far from our school to the museum.", wrongs: ["It not very far from our school to the museum.", "Our school is not very far to the museum."], trans: "Kh√¥ng xa l·∫Øm.", exp: "C√¢u ph·ªß ƒë·ªãnh v·ªõi It is." },
    
    // Ex 4: Choose correct answer
    { sec: "Looking Back", type: "text", q: "1. You ______ put rubbish in the bin.", ans: "should", wrongs: ["would", "shouldn't"], trans: "B·∫°n N√äN b·ªè r√°c v√†o th√πng.", exp: "H√†nh ƒë·ªông ƒë√∫ng." },
    { sec: "Looking Back", type: "text", q: "2. You ______ be over 18 to ride a motorbike.", ans: "must", wrongs: ["should", "could"], trans: "B·∫°n PH·∫¢I tr√™n 18 tu·ªïi.", exp: "Quy ƒë·ªãnh b·∫Øt bu·ªôc (Must)." },
    { sec: "Looking Back", type: "text", q: "3. Children ______ ride their bikes too fast.", ans: "shouldn't", wrongs: ["mightn't", "wouldn't"], trans: "Tr·∫ª em KH√îNG N√äN l√°i nhanh.", exp: "Nguy hi·ªÉm." },
    { sec: "Looking Back", type: "text", q: "4. I am lost. ______ you help me?", ans: "Could", wrongs: ["Should", "Must"], trans: "B·∫°n c√≥ th·ªÉ gi√∫p t√¥i kh√¥ng?", exp: "L·ªùi ƒë·ªÅ ngh·ªã l·ªãch s·ª± (Could)." },
    { sec: "Looking Back", type: "text", q: "5. You ______ eat so many cookies.", ans: "shouldn't", wrongs: ["couldn't", "wouldn't"], trans: "KH√îNG N√äN ƒÉn nhi·ªÅu b√°nh.", exp: "H·∫°i s·ª©c kh·ªèe." },
    { sec: "Looking Back", type: "text", q: "6. This is a park. You ______ run or cycle here.", ans: "can", wrongs: ["should", "could"], trans: "B·∫°n C√ì TH·ªÇ ch·∫°y ·ªü ƒë√¢y.", exp: "S·ª± cho ph√©p (Can)." }
];

/* =================================================================
   2. CORE FUNCTIONS
   ================================================================= */
let currentIdx = 0;
let score = 0;
let timer;
let synth = window.speechSynthesis;

// Shuffle function
function shuffle(array) {
    for (let i = array.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [array[i], array[j]] = [array[j], array[i]];
    }
    return array;
}

// Text to Speech
function speak(content, btnId) {
    if (synth.speaking) {
        synth.cancel();
        return;
    }
    const btn = document.getElementById(btnId);
    btn.classList.add('playing');
    btn.innerHTML = "‚èπ ƒêang ƒë·ªçc...";

    let idx = 0;
    function next() {
        if (idx >= content.length) {
            btn.classList.remove('playing');
            btn.innerText = "üîä Nghe ƒëo·∫°n vƒÉn";
            return;
        }
        const item = content[idx];
        const u = new SpeechSynthesisUtterance(item.t);
        u.lang = 'en-US';
        
        const voices = synth.getVoices();
        const m = voices.find(v => v.name.includes("Male"));
        const f = voices.find(v => v.name.includes("Female"));
        
        if(item.r === "Mark") { if(m) u.voice = m; u.pitch = 0.9; }
        else if(item.r === "Lan") { if(f) u.voice = f; u.pitch = 1.1; }
        
        u.onend = () => { idx++; next(); };
        synth.speak(u);
    }
    next();
}

function toggleTrans(id) {
    const els = document.querySelectorAll(`.vn-${id}`);
    els.forEach(el => el.classList.toggle('hidden'));
}

// Game Logic
function startGame() {
    document.getElementById('start-screen').style.display = 'none';
    document.getElementById('total').innerText = db.length;
    synth.getVoices();
    loadQ();
}

function loadQ() {
    clearTimeout(timer);
    synth.cancel();
    document.getElementById('timer').style.width = "0%";
    document.getElementById('timer').style.transition = "none";

    const data = db[currentIdx];
    const area = document.getElementById('game-area');
    
    // Update Progress
    document.getElementById('progress').style.width = `${((currentIdx)/db.length)*100}%`;

    area.innerHTML = '';
    
    // Badge
    const badge = document.createElement('div');
    badge.className = 'section-badge';
    badge.innerText = data.sec;
    area.appendChild(badge);

    // Reading/Visual with Translation
    if(data.type === 'dialogue') {
        let box = `<div class="reading-box">`;
        data.content.forEach((l, i) => {
            box += `<div style="margin-bottom:8px">
                <div class="line"><span class="role ${l.r}">${l.r}:</span> ${l.t}</div>
                <div class="vn-trans vn-${currentIdx} hidden">${l.v}</div>
            </div>`;
        });
        box += `</div>
        <div style="display:flex; gap:10px;">
            <button id="aud-${currentIdx}" class="btn-control">üîä Nghe ƒëo·∫°n vƒÉn</button>
            <button onclick="toggleTrans(${currentIdx})" class="btn-control btn-trans">üáªüá≥ Xem d·ªãch ti·∫øng Vi·ªát</button>
        </div>`;
        area.innerHTML += box;
        setTimeout(() => {
            document.getElementById(`aud-${currentIdx}`).onclick = () => speak(data.content, `aud-${currentIdx}`);
        }, 0);
    } else if (data.type === 'vis') {
        area.innerHTML += `<div style="text-align:center"><div class="visual-box">${data.vis}</div></div>`;
    }

    // Question
    const qDiv = document.createElement('div');
    qDiv.className = 'question-text';
    qDiv.innerText = `C√¢u ${currentIdx + 1}: ${data.q}`;
    area.appendChild(qDiv);

    // Options (Randomize Position)
    const optDiv = document.createElement('div');
    optDiv.className = 'options-grid';
    
    let options = [{txt: data.ans, correct: true}, ...data.wrongs.map(w => ({txt: w, correct: false}))];
    options = shuffle(options); 

    options.forEach(o => {
        const btn = document.createElement('button');
        btn.className = 'opt-btn';
        btn.innerText = o.txt;
        btn.onclick = () => check(btn, o.correct);
        optDiv.appendChild(btn);
    });
    area.appendChild(optDiv);

    // Feedback
    const fbDiv = document.createElement('div');
    fbDiv.id = 'fb-panel';
    fbDiv.className = 'feedback';
    fbDiv.innerHTML = `
        <div id="fb-status" class="fb-status"></div>
        <span class="fb-trans">D·ªãch: ${data.trans}</span>
        <div class="fb-exp">üí° ${data.exp}</div>
        <div class="auto-msg">‚è≥ T·ª± ƒë·ªông chuy·ªÉn c√¢u sau 4 gi√¢y...</div>
    `;
    area.appendChild(fbDiv);
}

function check(btn, isCorrect) {
    // Disable all buttons
    const btns = document.querySelectorAll('.opt-btn');
    btns.forEach(b => b.classList.add('disabled'));

    const fb = document.getElementById('fb-panel');
    const status = document.getElementById('fb-status');

    if (isCorrect) {
        btn.classList.add('correct');
        status.innerText = "‚úÖ CH√çNH X√ÅC!";
        status.style.color = "var(--secondary)";
        score++;
        document.getElementById('score').innerText = score;
    } else {
        btn.classList.add('wrong');
        status.innerText = "‚ùå SAI R·ªíI!";
        status.style.color = "var(--wrong)";
        
        // Highlight correct one
        const correctTxt = db[currentIdx].ans;
        btns.forEach(b => {
            if (b.innerText === correctTxt) b.classList.add('correct');
        });
    }

    fb.classList.add('show');

    // Timer Animation
    const line = document.getElementById('timer');
    line.style.transition = "width 4s linear";
    line.style.width = "100%";

    timer = setTimeout(() => {
        if(currentIdx < db.length - 1) {
            currentIdx++;
            loadQ();
        } else {
            finish();
        }
    }, 4000);
}

function finish() {
    document.getElementById('game-area').style.display = 'none';
    document.getElementById('end-screen').style.display = 'flex';
    document.getElementById('final-score').innerText = `${score} / ${db.length}`;
}

</script>
</body>
</html>